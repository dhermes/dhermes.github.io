<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>A Python Metaclass for "extra bad" errors in Google App Engine</title>
  <meta name="author" content="Danny Hermes">



  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="/favicon.png" rel="icon">
  <link href="/theme/css/katex.min.css" rel="stylesheet" type="text/css"/>
  <script src="/theme/js/katex.min.js" type="text/javascript"></script>
  <link href="/theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">
  <script src="/theme/js/modernizr-2.0.js"></script>
  <script src="/theme/js/ender.js"></script>
  <script src="/theme/js/octopress.js" type="text/javascript"></script>

  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="/">Bossylobster Blog</a></h1>
    <h2>Musings on humor/tech/mathematics/sports from the bossiest lobster</h2>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>


<form action="//google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>

<ul class="main-navigation">
    <li><a href="/archive.html">All Posts</a></li>
    <li><a href="http://github.com/dhermes/">GitHub Profile</a></li>
    <li><a href="http://math.berkeley.edu/~dhermes/">Berkeley Page</a></li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">A Python Metaclass for "extra bad" errors in Google App Engine</h1>
      <p class="meta"><time datetime="2011-11-30T00:00:00-08:00" pubdate>Nov 30, 2011</time></p>
</header>

  <div class="entry-content"><p>So now here we are, having tried to <a href="http://blog.bossylobster.com/2011/11/handling-errors-in-google-app-engineand.html">handle errors in Google App
Engine...and
failed</a> all
because silly <span class="Apple-style-span"
style="color: lime; font-family: 'Courier New', Courier, monospace;">DeadlineExceededError</span>
<a href="http://code.google.com/p/googleappengine/source/browse/trunk/python/google/appengine/runtime/__init__.py#32">jumps
over</a> <span
class="Apple-style-span"
style="color: lime; font-family: 'Courier New', Courier, monospace;">Exception</span>
in the inheritance chain and goes right for <span
class="Apple-style-span"
style="color: lime; font-family: 'Courier New', Courier, monospace;">BaseException</span>.
How can we catch these in our handlers while staying
<a href="http://docs.python.org/glossary.html#term-pythonic">Pythonic*</a>?</p>
<p>First and foremost, in the case of a timeout, we need to explicitly
catch a DeadlineExceededError. To do so, we can use a
<a href="http://stackoverflow.com/questions/739654/understanding-python-decorators#1594484">decorator</a> (hey,
that's Pythonic) in each and every handler for each and every HTTP
verb. (Again, <a href="http://troll.me/images/war-cat/prepare-yourself-for-war.jpg">prepare
yourselves</a>,
a bunch of code is about to happen. See the necessary
<a href="http://blog.bossylobster.com/2011/11/python-metaclass-for-extra-bad-errors.html#imports">imports</a>
at the bottom of the post.)</p>
<p>~~~~ {.prettyprint style="background-color: white;"}
def deadline_decorator(method):    def wrapped_method(self, <em>args, <strong>kwargs):        try:            method(self, *args, </strong>kwargs)        except DeadlineExceededError:            traceback_info = ''.join(format_exception(</em>sys.exc_info()))            email_admins(traceback_info, defer_now=True)            serve_500(self)    return wrapped_method</p>
<div class="highlight"><pre><span class="n">Unfortunately</span><span class="p">,</span> <span class="n">having</span> <span class="n">to</span> <span class="n">manually</span>

<span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;separator&quot;</span> <span class="n">style</span><span class="o">=</span><span class="s">&quot;clear: both; text-align: center;&quot;</span><span class="o">&gt;</span>

<span class="p">[</span><span class="o">!</span><span class="p">[](</span><span class="n">http</span><span class="o">:</span><span class="c1">//www.bossylobster.com/images/blog/decorate_all_the_functions.jpg)](http://www.bossylobster.com/images/blog/decorate_all_the_functions.jpg)</span>

<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>

<span class="n">is</span> <span class="n">not</span> <span class="n">so</span> <span class="n">Pythonic</span><span class="p">.</span> <span class="n">At</span> <span class="n">this</span> <span class="n">point</span> <span class="n">I</span> <span class="n">was</span> <span class="n">stuck</span> <span class="n">and</span> <span class="n">wanted</span> <span class="n">to</span> <span class="n">give</span> <span class="n">up</span><span class="p">,</span> <span class="n">but</span>
<span class="p">[</span><span class="n">asked</span> <span class="k">for</span> <span class="n">some</span>
<span class="n">advice</span><span class="p">](</span><span class="n">https</span><span class="o">:</span><span class="c1">//plus.google.com/u/0/114760865724135687241/posts/GJjXjq5zXhU)</span>
<span class="n">on</span> <span class="p">[</span><span class="n">G</span><span class="o">+</span><span class="p">](</span><span class="n">http</span><span class="o">:</span><span class="c1">//www.google.com/+) and actually got what I needed from the</span>
<span class="n">all</span> <span class="n">knowing</span> <span class="p">[</span><span class="n">Ali</span>
<span class="n">Afshar</span><span class="p">](</span><span class="n">https</span><span class="o">:</span><span class="c1">//plus.google.com/u/0/118327176775959145936/posts). What</span>
<span class="n">did</span> <span class="n">I</span>
<span class="n">need</span><span class="o">?</span><span class="err"> </span><span class="p">[</span><span class="n">Metaclasses</span><span class="p">](</span><span class="n">http</span><span class="o">:</span><span class="c1">//stackoverflow.com/questions/100003/what-is-a-metaclass-in-python#6581949).</span>

<span class="n">Before</span> <span class="n">showing</span> <span class="n">the</span> <span class="n">super</span> <span class="n">simple</span> <span class="n">metaclass</span> <span class="n">I</span> <span class="n">wrote</span><span class="p">,</span> <span class="n">you</span> <span class="n">need</span> <span class="n">to</span> <span class="n">know</span> <span class="n">one</span>
<span class="n">thing</span> <span class="n">from</span> <span class="n">StackOverflow</span> <span class="n">user</span> <span class="p">[</span><span class="n">Kevin</span>
<span class="n">Samuel</span><span class="p">](</span><span class="n">http</span><span class="o">:</span><span class="c1">//stackoverflow.com/users/9951/kevin-samuel):</span>

<span class="o">&gt;</span> <span class="n">The</span> <span class="n">main</span> <span class="n">purpose</span> <span class="n">of</span> <span class="n">a</span> <span class="n">metaclass</span> <span class="n">is</span> <span class="n">to</span> <span class="n">change</span> <span class="n">the</span> <span class="n">class</span> <span class="n">automatically</span><span class="p">,</span>
<span class="o">&gt;</span> <span class="n">when</span> <span class="n">it</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">created</span><span class="p">.</span>

<span class="n">With</span> <span class="n">the</span> <span class="o">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;Apple-style-span&quot;</span>
<span class="n">style</span><span class="o">=</span><span class="s">&quot;color: lime; font-family: &#39;Courier New&#39;, Courier, monospace;&quot;</span><span class="o">&gt;</span><span class="err">\</span><span class="n">_</span><span class="err">\</span><span class="n">_new</span><span class="err">\</span><span class="n">_</span><span class="err">\</span><span class="n">_</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
<span class="n">method</span><span class="p">,</span> <span class="n">the</span> <span class="o">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;Apple-style-span&quot;</span>
<span class="n">style</span><span class="o">=</span><span class="s">&quot;color: lime; font-family: &#39;Courier New&#39;, Courier, monospace;&quot;</span><span class="o">&gt;</span><span class="n">type</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
<span class="n">object</span> <span class="k">in</span> <span class="n">Python</span> <span class="n">actually</span> <span class="n">constructs</span> <span class="n">a</span> <span class="n">class</span> <span class="p">(</span><span class="n">which</span> <span class="n">is</span> <span class="n">also</span> <span class="n">an</span> <span class="n">object</span><span class="p">)</span>
<span class="n">by</span> <span class="n">taking</span> <span class="n">into</span> <span class="n">account</span> <span class="n">the</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">class</span><span class="p">,</span> <span class="n">the</span> <span class="n">parents</span> <span class="p">(</span><span class="n">or</span> <span class="n">bases</span><span class="p">)</span> <span class="n">and</span>
<span class="n">the</span> <span class="n">class</span> <span class="n">attritubutes</span><span class="p">.</span> <span class="n">So</span><span class="p">,</span> <span class="n">we</span> <span class="n">can</span> <span class="n">make</span> <span class="n">a</span> <span class="n">metaclass</span> <span class="n">by</span> <span class="n">subclassing</span><span class="err"> </span><span class="o">&lt;</span><span class="n">span</span>
<span class="n">class</span><span class="o">=</span><span class="s">&quot;Apple-style-span&quot;</span>
<span class="n">style</span><span class="o">=</span><span class="s">&quot;color: lime; font-family: &#39;Courier New&#39;, Courier, monospace;&quot;</span><span class="o">&gt;</span><span class="n">type</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;</span><span class="err"> </span><span class="n">and</span>
<span class="n">overriding</span><span class="err"> </span><span class="o">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;Apple-style-span&quot;</span>
<span class="n">style</span><span class="o">=</span><span class="s">&quot;color: lime; font-family: &#39;Courier New&#39;, Courier, monospace;&quot;</span><span class="o">&gt;</span><span class="err">\</span><span class="n">_</span><span class="err">\</span><span class="n">_new</span><span class="err">\</span><span class="n">_</span><span class="err">\</span><span class="n">_</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;:</span>

<span class="o">~~~~</span> <span class="p">{.</span><span class="n">prettyprint</span> <span class="n">style</span><span class="o">=</span><span class="s">&quot;background-color: white;&quot;</span><span class="p">}</span>
<span class="n">class</span> <span class="n">DecorateHttpVerbsMetaclass</span><span class="p">(</span><span class="n">type</span><span class="p">)</span><span class="o">:</span>    <span class="n">def</span> <span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">cls_attr</span><span class="p">)</span><span class="o">:</span>        <span class="n">verbs</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">get</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">post</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">put</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">delete</span><span class="err">&#39;</span><span class="p">]</span>        <span class="k">for</span> <span class="n">verb</span> <span class="k">in</span> <span class="n">verbs</span><span class="o">:</span>            <span class="k">if</span> <span class="n">verb</span> <span class="k">in</span> <span class="n">cls_attr</span> <span class="n">and</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">cls_attr</span><span class="p">[</span><span class="n">verb</span><span class="p">],</span> <span class="n">function</span><span class="p">)</span><span class="o">:</span>                <span class="n">cls_attr</span><span class="p">[</span><span class="n">verb</span><span class="p">]</span> <span class="o">=</span> <span class="n">deadline_decorator</span><span class="p">(</span><span class="n">cls_attr</span><span class="p">[</span><span class="n">verb</span><span class="p">])</span>        <span class="k">return</span> <span class="n">super</span><span class="p">(</span><span class="n">DecorateHttpVerbsMetaclass</span><span class="p">,</span> <span class="n">cls</span><span class="p">).</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>                                                              <span class="n">bases</span><span class="p">,</span> <span class="n">cls_attr</span><span class="p">)</span>
</pre></div>


<p>In <span class="Apple-style-span"
style="color: lime; font-family: 'Courier New', Courier, monospace;">DecorateHttpVerbsMetaclass</span>,
we look for four (of the nine) HTTP
<a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_methods">verbs</a>,
because heck, only seven are supported in
<a href="http://code.google.com/appengine/docs/python/tools/webapp/requesthandlerclass.html">RequestHandler</a>,
and we're not that crazy. If the class has one of the verbs as an
attribute <strong><em>and if</em></strong> the attribute is a function, we
<a href="http://troll.me/images/misc-corrupted-husband/i-try-to-decorate-the-house-he-puts-spiderman-images-everywhere.jpg">decorate</a>
it with <span class="Apple-style-span"
style="color: lime; font-family: 'Courier New', Courier, monospace;">deadline_decorator</span>.</p>
<p>Now, we can rewrite our subclass of <span class="Apple-style-span"
style="color: lime; font-family: 'Courier New', Courier, monospace;">RequestHandler</span>
with one extra line:</p>
<p>~~~~ {.prettyprint style="background-color: white;"}
class ExtendedHandler(RequestHandler):    <strong>metaclass</strong> = DecorateHttpVerbsMetaclass    def handle_exception(self, exception, debug_mode):        traceback_info = ''.join(format_exception(*sys.exc_info()))        email_admins(traceback_info, defer_now=True)        serve_500(self)</p>
<div class="highlight"><pre><span class="k">By</span> <span class="nx">doing</span> <span class="nx">this</span><span class="p">,</span> <span class="nx">when</span> <span class="nx">the</span> <span class="o">***</span><span class="nb">class</span><span class="o">***</span> <span class="o">&lt;</span><span class="nx">span</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;Apple-style-span&quot;</span>
<span class="n">style</span><span class="o">=</span><span class="s2">&quot;color: lime; font-family: &#39;Courier New&#39;, Courier, monospace;&quot;</span><span class="o">&gt;</span><span class="nx">ExtendedHandler</span><span class="o">&lt;/</span><span class="nx">span</span><span class="o">&gt;</span>
<span class="nx">is</span> <span class="nx">built</span> <span class="p">(</span><span class="nx">as</span> <span class="nx">an</span> <span class="o">***</span><span class="nb">object</span><span class="o">***</span><span class="p">),</span> <span class="kc">all</span> <span class="nx">of</span> <span class="nx">its</span> <span class="nb">attributes</span> <span class="ow">and</span> <span class="kc">all</span> <span class="nx">of</span> <span class="nx">its</span>
<span class="k">parent</span> <span class="nx">classes</span> <span class="p">(</span><span class="ow">or</span> <span class="nx">bases</span><span class="p">)</span><span class="err"> </span><span class="nb">attributes</span> <span class="nx">are</span> <span class="nb">checked</span> <span class="ow">and</span> <span class="nx">possibly</span> <span class="nx">updated</span> <span class="k">by</span>
<span class="nx">our</span> <span class="nx">metaclass.</span>

<span class="ow">And</span> <span class="nx">now</span> <span class="nx">you</span> <span class="ow">and</span> <span class="nx">James</span> <span class="nx">Nekbehrd</span> <span class="nx">can</span> <span class="nx">feel</span><span class="err"> [</span><span class="nx">like</span> <span class="nx">a</span>
<span class="nx">boss</span><span class="cp">]</span>(http://www.youtube.com/watch?v=NisCkxU544c) when your app handles
errors.

**<span class="cp">[</span><span class="nx">Imports</span><span class="p">:</span><span class="cp">]</span>(http://blog.bossylobster.com/2011/11/python-metaclass-for-extra-bad-errors.html#imports)**

~~~~ {.prettyprint style=&quot;background-color: white;&quot;}
from google.appengine.api import mailfrom google.appengine.ext.deferred import deferfrom google.appengine.ext.webapp import RequestHandlerfrom google.appengine.runtime import DeadlineExceededErrorimport sysfrom traceback import format_exceptionfrom SOME_APP_SPECIFIC_LIBRARY import serve_500from LAST_POST import email_admins
</pre></div>


<p><strong>*Pythonic:</strong></p>
<blockquote>
<p><em>An idea or piece of code which closely follows the most common idioms
of the Python language, rather than implementing code using concepts
common to other languages.</em></p>
</blockquote>
<p><strong>Notes:</strong></p>
<ul>
<li><em>Using</em> <span class="Apple-style-span"
    style="background-color: white; color: purple; font-family: 'Courier New', Courier, monospace;">grep
    -r "Exception)" . | grep "class "</span> <em>I have convinced myself
    (for now) that the only errors AppEngine will throw that do not
    inherit from</em><span class="Apple-style-span"
    style="color: lime; font-family: 'Courier New', Courier, monospace;">Exception</span><em>are</em><span
    class="Apple-style-span"
    style="color: lime; font-family: 'Courier New', Courier, monospace;">DeadlineExceededError</span><em>,</em><span
    class="Apple-style-span"
    style="color: lime; font-family: 'Courier New', Courier, monospace;">SystemExit</span><em>,
    and</em><span class="Apple-style-span"
    style="color: lime; font-family: 'Courier New', Courier, monospace;">KeyboardInterrupt</span><em>so
    that is why I only catch the timeout.</em></li>
<li><em>You can also use</em><span class="Apple-style-span"
    style="color: lime; font-family: 'Courier New', Courier, monospace;">webapp2</span><em>to
    <a href="http://stackoverflow.com/questions/6853257/how-can-i-setup-a-global-deadlineexceedederror-handler">catch 500
    errors</a>,
    even when</em><span class="Apple-style-span"
    style="color: lime; font-family: 'Courier New', Courier, monospace;">handle_exception</span><em>fails
    to catch them.</em></li>
</ul>
<p><strong>Disclaimer:</strong> <em>Just because you know what a metaclass is doesn't mean
you should use one:</em></p>
<ul>
<li><em>"Don't do stuff like this though, what is your use case?" -Ali
    Afshar</em></li>
<li><em>"Metaclasses are deeper magic than 99% of users should ever worry
    about. If you wonder whether you need them, you don't (the people
    who actually need them know with certainty that they need them, and
    don't need an explanation about why)." -Python Guru Tim Peters</em></li>
<li><em>"The main use case for a metaclass is creating an API." -Kevin
    Samuel</em></li>
</ul>
<p><a href="https://profiles.google.com/114760865724135687241" rel="author" style="display: none;">About Bossy Lobster</a></p></div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">Danny Hermes (dhermes@bossylobster.com)</span>
  </span>
<time datetime="2011-11-30T00:00:00-08:00" pubdate>Nov 30, 2011</time>  <span class="categories">
    <a class="category" href="/tag/appengine.html">AppEngine</a>
    <a class="category" href="/tag/class-as-object.html">Class as Object</a>
    <a class="category" href="/tag/decorator.html">Decorator</a>
    <a class="category" href="/tag/exception.html">Exception</a>
    <a class="category" href="/tag/google-app-engine.html">Google App Engine</a>
    <a class="category" href="/tag/metaclass.html">Metaclass</a>
    <a class="category" href="/tag/oop.html">OOP</a>
    <a class="category" href="/tag/python.html">Python</a>
    <a class="category" href="/tag/pythonic.html">Pythonic</a>
    <a class="category" href="/tag/request-handler.html">Request Handler</a>
  </span>
</p><div class="sharing">
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="/2011/11/python-metaclass-for-extra-bad-errors.html" data-via="bossylobster" data-counturl="/2011/11/python-metaclass-for-extra-bad-errors.html" >Tweet</a>
  <div class="g-plusone" data-size="medium"></div>
</div>    </footer>
  </article>

</div>
<aside class="sidebar">
  <section>
    <img src="/images/bossy_lobster_200_alpha.png" alt="" width=""/>
  </section>
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="/2014/09/quantitative-interview-brain-teaser.html">Quantitative Interview Brain Teaser: Computer Assistance</a>
      </li>
      <li class="post">
          <a href="/2014/09/quantitative-brain-teaser-brain-only.html">Quantitative Brain Teaser: Brain Only</a>
      </li>
      <li class="post">
          <a href="/2014/08/math-for-humans-second-attempt.html">Math for Humans, A Second Attempt</a>
      </li>
      <li class="post">
          <a href="/2014/07/bayes-law-primer.html">Bayes' Law Primer</a>
      </li>
      <li class="post">
          <a href="/2014/07/conditional-probabilities-in-thinking.html">Conditional Probabilities in "Thinking Fast and Slow"</a>
      </li>
    </ul>
  </section>




<section>
    <a href="http://twitter.com/bossylobster" class="twitter-follow-button" data-show-count="true">Follow @bossylobster</a>
</section>
</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2011-2014  - Danny Hermes -
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>
</body>
</html>