<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Quick and Dirty: Santa's Coming</title>
  <meta name="author" content="Danny Hermes">



  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="/favicon.png" rel="icon">
  <link href="/theme/css/katex.min.css" rel="stylesheet" type="text/css"/>
  <script src="/theme/js/katex.min.js" type="text/javascript"></script>
  <link href="/theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">
  <script src="/theme/js/modernizr-2.0.js"></script>
  <script src="/theme/js/ender.js"></script>
  <script src="/theme/js/octopress.js" type="text/javascript"></script>

  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="/">Bossylobster Blog</a></h1>
    <h2>Musings on humor/tech/mathematics/sports from the bossiest lobster</h2>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>


<form action="//google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>

<ul class="main-navigation">
    <li><a href="/archive.html">All Posts</a></li>
    <li><a href="http://github.com/dhermes/">GitHub Profile</a></li>
    <li><a href="http://math.berkeley.edu/~dhermes/">Berkeley Page</a></li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">Quick and Dirty: Santa's Coming</h1>
      <p class="meta"><time datetime="2011-11-17T00:00:00-08:00" pubdate>Nov 17, 2011</time></p>
</header>

  <div class="entry-content"><p>I have been wanting to write a post for awhile, but was travelling for a
<a href="https://sites.google.com/site/barcelonadevfest/">work event</a> and while
on the road I decided to be lazy.</p>
<p>Since I just so happen to use a few <a href="http://code.google.com/apis/gdata/">GData
APIs</a> occasionally in my day to day
work, most of the post ideas revolve around quirky things I have done or
want to do with the APIs. Also, due to my obscene love for Python, all
my mashups seem to end up using the <a href="http://code.google.com/p/gdata-python-client/">Python Client for
GData</a>.</p>
<p><strong>Back-story:</strong> As I was finalizing travel and gifts for my winter
holiday back home, I called an old friend to let him know I'd be home in
40 days. After relaying this information to a few other people, I noted
to my girlfriend that it would be nice if a computer would remind me of
the count every day. This is where this quick and dirty pair of scripts
come in to remind me when Santa is coming.</p>
<p><strong>Pre-work — Account Settings: </strong>To allow an app to make requests on my
behalf, I signed up to <a href="https://accounts.google.com/ManageDomains">Manage my
Domain</a> for use with Google
Apps, etc. For illustration purposes, let's say I used <span
class="Apple-style-span"
style="color: lime; font-family: 'Courier New', Courier, monospace;">http://example.com</span> (in
reality, I used a pre-existing App of mine, I really just needed an
OAuth token for one time use, no real safety concerns there). After
adding this domain in the management page, I am able to get my <em>"OAuth
Consumer Key"</em> and <em>"OAuth Consumer Secret"</em> which we'll say are <span
class="Apple-style-span"
style="color: lime; font-family: 'Courier New', Courier, monospace;">EXAMPLE_KEY</span> and
<span class="Apple-style-span"
style="color: lime; font-family: 'Courier New', Courier, monospace;">EXAMPLE_SECRET</span> in
this example. Also in the management page, I set my <em>"OAuth 2.0 Redirect
URIs"</em> and made sure my app can serve that page (even if it is a 404).
Again for illustration, let's pretend I used <span
class="Apple-style-span"
style="color: lime; font-family: 'Courier New', Courier, monospace;">http://example.com/verify</span>.</p>
<p>After doing this settings pre-work, I have two scripts to do the work
for me.</p>
<p><strong>First script — get the OAuth Token:</strong></p>
<p>~~~~ {.prettyprint style="background-color: white;"}
import gdata.calendar.clientimport gdata.gauthgcal = gdata.calendar.client.CalendarClient()oauth_callback = 'http://example.com/verify'scopes = ['https://www.google.com/calendar/feeds/']consumer_key = 'EXAMPLE_KEY'consumer_secret = 'EXAMPLE_SECRET'request_token = gcal.get_oauth_token(scopes, oauth_callback,                                     consumer_key, consumer_secret)out_str = ('Please visit https://www.google.com/accounts/OAuthAuthorize'           'Token?hd=default&amp;oauth_token=%s' % request_token.token)print out_strfollow = raw_input('Please entry the follow link after authorizing:\n')gdata.gauth.authorize_request_token(request_token, follow)gcal.auth_token = gcal.get_access_token(request_token)print 'TOKEN:', gcal.auth_token.tokenprint 'TOKEN_SECRET:', gcal.auth_token.token_secret</p>
<div class="highlight"><pre><span class="nx">This</span> <span class="nb">script</span> <span class="s2">&quot;spoofs&quot;</span> <span class="nx">the</span> <span class="nx">OAuth</span> <span class="nx">handshake</span> <span class="k">by</span> <span class="nx">asking</span> <span class="nx">the</span> <span class="nb">user</span> <span class="p">(</span><span class="nx">me</span><span class="p">)</span> <span class="k">to</span> <span class="nx">go</span>
<span class="nx">directly</span> <span class="k">to</span> <span class="nx">the</span> <span class="err">[</span><span class="nx">OAuth</span> <span class="nb">Authorize</span>
<span class="nx">page</span><span class="cp">]</span>(https://www.google.com/accounts/OAuthAuthorizeToken). After doing
so and authorizing the App, I am redirected to <span class="nt">&lt;span</span>
<span class="na">class=</span><span class="s">&quot;Apple-style-span&quot;</span>
<span class="na">style=</span><span class="s">&quot;color: lime; font-family: &#39;Courier New&#39;, Courier, monospace;&quot;</span><span class="nt">&gt;</span>http://example.com/verify<span class="nt">&lt;/span&gt;</span> with
query parameters for <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;Apple-style-span&quot;</span>
<span class="na">style=</span><span class="s">&quot;color: lime; font-family: &#39;Courier New&#39;, Courier, monospace;&quot;</span><span class="nt">&gt;</span>oauth\_verifier<span class="nt">&lt;/span&gt;</span>
and <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;Apple-style-span&quot;</span>
<span class="na">style=</span><span class="s">&quot;color: lime; font-family: &#39;Courier New&#39;, Courier, monospace;&quot;</span><span class="nt">&gt;</span>oauth\_token<span class="nt">&lt;/span&gt;</span>.
These are then used by the <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;Apple-style-span&quot;</span>
<span class="na">style=</span><span class="s">&quot;color: lime; font-family: &#39;Courier New&#39;, Courier, monospace;&quot;</span><span class="nt">&gt;</span>gauth<span class="nt">&lt;/span&gt;</span>
section of the GData library to finish the OAuth handshake. Once the
handshake is complete, the script prints out a necessary token and token
secret to be used by the second script. I would advise piping the output
to a file, augmenting the script to write them to a file, or writing
these down (this is a joke, please don&#39;t write down 40 plus character
goop that was ***produced by your computer***). For the next script,
let&#39;s pretend our token is <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;Apple-style-span&quot;</span>
<span class="na">style=</span><span class="s">&quot;color: lime; font-family: &#39;Courier New&#39;, Courier, monospace;&quot;</span><span class="nt">&gt;</span>FAKE\_TOKEN<span class="nt">&lt;/span&gt;</span> and
our token secret is <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;Apple-style-span&quot;</span>
<span class="na">style=</span><span class="s">&quot;color: lime; font-family: &#39;Courier New&#39;, Courier, monospace;&quot;</span><span class="nt">&gt;</span>FAKE\_TOKEN\_SECRET<span class="nt">&lt;/span&gt;</span>.

**Second script — insert the events:**

~~~~ {.prettyprint style=&quot;background-color: white;&quot;}
# General librariesfrom datetime import datefrom datetime import timedelta# Third-party librariesimport atomimport gdata.gauthimport gdata.calendar.clientimport gdata.calendar.datagcal = gdata.calendar.client.CalendarClient()auth_token = gdata.gauth.OAuthHmacToken(consumer_key=&#39;EXAMPLE_KEY&#39;,                                        consumer_secret=&#39;EXAMPLE_SECRET&#39;,                                        token=&#39;FAKE_TOKEN&#39;,                                        token_secret=&#39;FAKE_TOKEN_SECRET&#39;,                                        auth_state=3)gcal.auth_token = auth_tokentoday = date.today()days_left = (date(year=2011, month=12, day=23) - today).dayswhile days_left &gt;= 0:    event = gdata.calendar.data.CalendarEventEntry()    if days_left &gt; 1:        msg = &#39;%s Days Until Home for Christmas&#39; % days_left    elif days_left == 1:        msg = &#39;1 Day Until Home for Christmas&#39;    elif days_left == 0:        msg = &#39;Going Home for Christmas&#39;    event.title = atom.data.Title(msg)    # When    start_time = &#39;2011-%02d-%02dT08:00:00.000-08:00&#39; % (today.month, today.day)    end_time = &#39;2011-%02d-%02dT09:00:00.000-08:00&#39; % (today.month, today.day)    event.when.append(gdata.calendar.data.When(        start=start_time,        end=end_time,        reminder=<span class="cp">[</span><span class="nx">gdata.data.Reminder</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">)</span><span class="cp">]</span>))    gcal.InsertEvent(event)    today += timedelta(days=1)    days_left -= 1
</pre></div>


<p>This script first authenticates by using the key/secret pair for the
application (retrieved from the settings page) and the key/secret pair
for the user token (that we obtained from the first script). To
authenticate, we explicitly construct an HMAC-SHA1 signed token in the
final auth state (3) of two-legged OAuth and then set the token on our
calendar client (<span class="Apple-style-span"
style="color: lime; font-family: 'Courier New', Courier, monospace;">gcal</span>).</p>
<p>After authenticating, we start with today and figure out the number of
days in the countdown given my return date of December 23, 2011. With
these in hand, we can loop through until there are no days left,
creating a <span class="Apple-style-span"
style="color: lime; font-family: 'Courier New', Courier, monospace;">CalendarEventEntry</span>
with title as the number of days left in the countdown and occurring
from 8am to 9am PST (UTC -8). Notice also I include a <span
class="Apple-style-span"
style="color: lime; font-family: 'Courier New', Courier, monospace;">gdata.data.Reminder</span>
so I get an email at 7am every morning (60 minutes before the
event) updating my brain on the length of the countdown!</p>
<p><strong>Cleanup:</strong> Be sure to go to your <a href="https://accounts.google.com/IssuedAuthSubTokens">issued tokens
page</a> and revoke access
to the App (e.g. <span class="Apple-style-span"
style="color: lime; font-family: 'Courier New', Courier, monospace;">http://example.com</span>)
after doing this to avoid any unwanted security issues.</p>
<div>

**References:***I have never read this, but I'm sure the documentation
on [Registration for Web-Based
Applications](http://code.google.com/apis/accounts/docs/RegistrationForWebAppsAuto.html) is
very helpful.*

**Notes:**
-   *You can annoy other people by inviting them to these events for
    them as well. To do so, simply add the following two lines before
    inserting the event*

    ~~~~ {.prettyprint style="background-color: white;"}
    who_add = gdata.calendar.data.EventWho(email='name@mail.com')event.who.append(who_add)
    ~~~~

-   *Sometimes inserting an item results in a RedirectError, so it may
    be safer to try the insert multiple times with a helper function
    such as the following:*

    ~~~~ {.prettyprint style="background-color: white;"}
    def try_insert(attempts, gcal, event):    from time import sleep    from gdata.client import RedirectError    while attempts > 0:      try:          gcal.InsertEvent(event)          break      except RedirectError:          attempts -= 1          sleep(3)          pass    if attempts == 0:        print 'Insert "%s" failed' % event.title.text
    ~~~~

-   *In what I swear was a complete coincidence, v3 of the Calendar API
    was
    [announced](http://googleappsdeveloper.blogspot.com/2011/11/introducing-next-version-of-google.html)
    today. I will try to use the [new
    documentation](https://code.google.com/apis/calendar/v3/getting_started.html)
    to redo this quick and dirty example with v3.*

</div>

<p><a href="https://profiles.google.com/114760865724135687241" rel="author" style="display: none;">About Bossy Lobster</a></p></div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">Danny Hermes (dhermes@bossylobster.com)</span>
  </span>
<time datetime="2011-11-17T00:00:00-08:00" pubdate>Nov 17, 2011</time>  <span class="categories">
    <a class="category" href="/tag/api.html">API</a>
    <a class="category" href="/tag/christmas.html">Christmas</a>
    <a class="category" href="/tag/gcal.html">GCal</a>
    <a class="category" href="/tag/gdata.html">GData</a>
    <a class="category" href="/tag/google-calendar.html">Google Calendar</a>
    <a class="category" href="/tag/oauth.html">OAuth</a>
    <a class="category" href="/tag/oauth20.html">OAuth2.0</a>
    <a class="category" href="/tag/python.html">Python</a>
    <a class="category" href="/tag/santa.html">Santa</a>
  </span>
</p><div class="sharing">
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="/2011/11/quick-and-dirty-santas-coming.html" data-via="bossylobster" data-counturl="/2011/11/quick-and-dirty-santas-coming.html" >Tweet</a>
  <div class="g-plusone" data-size="medium"></div>
</div>    </footer>
  </article>

</div>
<aside class="sidebar">
  <section>
    <img src="/images/bossy_lobster_200_alpha.png" alt="" width=""/>
  </section>
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="/2014/09/quantitative-interview-brain-teaser.html">Quantitative Interview Brain Teaser: Computer Assistance</a>
      </li>
      <li class="post">
          <a href="/2014/09/quantitative-brain-teaser-brain-only.html">Quantitative Brain Teaser: Brain Only</a>
      </li>
      <li class="post">
          <a href="/2014/08/math-for-humans-second-attempt.html">Math for Humans, A Second Attempt</a>
      </li>
      <li class="post">
          <a href="/2014/07/bayes-law-primer.html">Bayes' Law Primer</a>
      </li>
      <li class="post">
          <a href="/2014/07/conditional-probabilities-in-thinking.html">Conditional Probabilities in "Thinking Fast and Slow"</a>
      </li>
    </ul>
  </section>




<section>
    <a href="http://twitter.com/bossylobster" class="twitter-follow-button" data-show-count="true">Follow @bossylobster</a>
</section>
</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2011-2014  - Danny Hermes -
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>
</body>
</html>