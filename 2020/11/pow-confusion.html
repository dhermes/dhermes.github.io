<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head itemscope itemtype="http://schema.org/Article">
  <meta charset="utf-8">
  <title>pow Confusion &mdash; Bossy Lobster</title>
  <meta name="author" content="Danny Hermes">
  <meta name="description" content="Losing a Whole Week to Exponentiation" />

  <link href="https://blog.bossylobster.com/feeds/atom.xml" type="application/atom+xml" rel="alternate"
        title="Bossy Lobster Atom Feed" />
  <link href="https://blog.bossylobster.com/feeds/rss.xml" type="application/rss+xml" rel="alternate"
        title="Bossy Lobster RSS Feed" />

    <link href="/css/custom.css" rel="stylesheet" type="text/css"/>
<link href="/css/katex.min.css" rel="stylesheet" type="text/css"/>


<!-- Schema.org markup for Google+ -->
<meta itemprop="name" content="<p><code>pow</code> Confusion</p>" />
<meta itemprop="description" content="Losing a Whole Week to Exponentiation" />
<meta itemprop="image" content="https://blog.bossylobster.com/images/fortran-exponent.png" />

<!-- Open Graph data -->
<meta property="og:type" content="article" />
<meta property="og:title" content="<p><code>pow</code> Confusion</p>" />
<meta property="og:image" content="https://blog.bossylobster.com/images/fortran-exponent.png" />
<meta property="og:description" content="Losing a Whole Week to Exponentiation" />

<!-- Twitter Card data -->
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@bossylobster" />
<meta name="twitter:title" content="<p><code>pow</code> Confusion</p>" />
<meta name="twitter:description" content="Losing a Whole Week to Exponentiation" />
<meta name="twitter:creator" content="@bossylobster" />
<meta name="twitter:image" content="https://blog.bossylobster.com/images/fortran-exponent.png" />

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


    <link href="https://blog.bossylobster.com/favicon.png" rel="icon">

  <link href="https://blog.bossylobster.com/theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">

  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="https://blog.bossylobster.com/">Bossy Lobster</a></h1>
    <h2>A blog by Danny Hermes; musing on tech, mathematics, etc.</h2>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="https://blog.bossylobster.com/feeds/atom.xml" rel="subscribe-atom">Atom</a></li>
  <li><a href="https://blog.bossylobster.com/feeds/rss.xml" rel="subscribe-rss">RSS</a></li>
</ul>

<form action="//google.com/search" method="get" id="site-search">
  <fieldset role="search">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<script>
function site_search_submit(submit_event) {
  var form_element = submit_event.srcElement;
  var query_elt = form_element.elements['q'];
  
  query_elt.value = 'site:https://blog.bossylobster.com ' + query_elt.value;
  
}
document.getElementById('site-search').onsubmit = site_search_submit;
</script>

<ul class="main-navigation">
    <li><a href="/all-posts.html">All Posts</a></li>
    <li><a href="http://github.com/dhermes/">GitHub</a></li>
    <li><a href="/mathematics">Mathematics</a></li>
    <li><a href="/testimonials">Testimonials</a></li>
    <li><a href="/about-me">About Me</a></li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <a href="https://github.com/dhermes/bossylobster-blog/blob/master/templated_content/2020-11-25-pow-confusion.template" class="fab fa-github"> Edit on GitHub</a>
      <h1 class="entry-title">pow Confusion</h1>
    <p class="meta">
<time datetime="2020-11-25T00:00:00-08:00" pubdate>Nov 25, 2020</time>    </p>
</header>

  <div class="entry-content"><p>In my first summer of graduate school my code suddenly stopped working
because Fortran and Python (via <code>pow()</code> in C) do exponentiation differently.
Once I debugged and understood the problem, I learned about the highly
optimized assembly code produced by Fortran for integer exponents.</p>
<p>To give a sample of the tool I wrote, here is an analysis of the assembly
generated by the <code>gfortran</code> compiler for <code>b = a**5</code>:</p>
<div class=highlight><pre><span></span><code>$ python ./describe_assembly.py --exponent 5
+-------------------------+------------+
|        %xmm0[:64]       | %xmm1[:64] |
+-------------------------+------------+
|            a            |            | f2 0f 10 07     movsd   [(%rdi), %xmm0 ]
|            a            |     a      | 66 0f 28 c8     movapd  [ %xmm0, %xmm1 ]
|            a            |   a * a    | f2 0f 59 c8     mulsd   [ %xmm0, %xmm1 ]
|       (a * a) * a       |   a * a    | f2 0f 59 c1     mulsd   [ %xmm1, %xmm0 ]
| (a * a) * ((a * a) * a) |   a * a    | f2 0f 59 c1     mulsd   [ %xmm1, %xmm0 ]
|            b            |            | f2 0f 11 06     movsd   [ %xmm0, (%rsi)]
+-------------------------+------------+
</code></pre></div>

<h3>Contents</h3>
<ul>
<li><a href=#motivation>Motivation</a></li>
<li><a href=#difference>What's the Difference?</a></li>
<li><a href=#fortran-algorithm>Fortran's Nifty Algorithm</a></li>
<li><a href=#assembly>I Don't Speak Assembly</a></li>
</ul>
<h3 id=motivation>Motivation</h3>
<p>In my first summer of graduate school, I had a very productive June. I was
working on a research project<sup id=sf-pow-confusion-1-back><a href=#sf-pow-confusion-1 class=simple-footnote title="The project unfortunately never led to results that could be published.">1</a></sup> on optimization of triangular meshes for
compression and storage. A core part of this involved taking fourth powers of
floating point numbers<sup id=sf-pow-confusion-2-back><a href=#sf-pow-confusion-2 class=simple-footnote title="I.e., values of type double in C">2</a></sup>. Once I
reached a point where my slow Python code worked well enough, I started porting
to Fortran 95. I foolishly expected bit-for-bit identical behavior but instead
the changes — which I later learned were exclusively from the fourth
power operation — were so dramatic I lost a <strong>full week</strong> of productivity
debugging the existing test cases.</p>
<p>As with most optimization problems, this involved applying
<a href="https://en.wikipedia.org/wiki/Gradient_descent">gradient descent</a><sup id=sf-pow-confusion-3-back><a href=#sf-pow-confusion-3 class=simple-footnote title="and related algorithms">3</a></sup> to a number of
handpicked objective functions. Since this involved triangles and compression,
we were trying to modify the mesh<sup id=sf-pow-confusion-4-back><a href=#sf-pow-confusion-4 class=simple-footnote title="It's worth noting that for our purposes a trianglular mesh is just a collection of triangles that share edges, so if one triangle changes, the neighboring triangles must as well.">4</a></sup> by
"binning" triangles into similar shapes. For our early objective functions,
this could lead to flattened out triangles that looked more like lines than
triangles. Luckily there <a href="https://doi.org/10.1090/S0025-5718-03-01485-6">exist</a> a number of ways to measure the "quality"
<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0.625em;vertical-align:-0.19444em;></span><span class="mord mathnormal" style=margin-right:0.03588em;>q</span></span></span></span> of a triangle as a number between <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0.64444em;vertical-align:0em;></span><span class=mord>0</span></span></span></span> and
<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0.64444em;vertical-align:0em;></span><span class=mord>1</span></span></span></span>; a very low quality corresponds exactly
to this flatness. To penalize low-quality triangles we included functions of
<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi mathvariant=normal>/</mi><mi>q</mi></mrow><annotation encoding="application/x-tex">1 / q</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1em;vertical-align:-0.25em;></span><span class=mord>1/</span><span class="mord mathnormal" style=margin-right:0.03588em;>q</span></span></span></span> in our objective functions and several of the most
successful used a loop over all triangles <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0.68333em;vertical-align:0em;></span><span class="mord mathnormal" style=margin-right:0.13889em;>T</span></span></span></span> in the mesh
<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=script>M</mi></mrow><annotation encoding="application/x-tex">\mathcal{M}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0.68333em;vertical-align:0em;></span><span class="mord mathcal">M</span></span></span></span></p>
<div class=katex-elt><blockquote>
<span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display=block><semantics><mrow><munder><mo>∑</mo><mrow><mi>T</mi><mo>∈</mo><mi mathvariant=script>M</mi></mrow></munder><mfrac><mn>1</mn><mrow><mi>q</mi><mo stretchy=false>(</mo><mi>T</mi><msup><mo stretchy=false>)</mo><mn>4</mn></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\sum_{T \in \mathcal{M}} \frac{1}{q(T)^4}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:2.6431459999999998em;vertical-align:-1.321706em;></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.050005em;><span style=top:-1.8556639999999998em;margin-left:0em;><span class=pstrut style=height:3.05em;></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:0.13889em;>T</span><span class="mrel mtight">∈</span><span class="mord mathcal mtight">M</span></span></span></span><span style=top:-3.0500049999999996em;><span class=pstrut style=height:3.05em;></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.321706em;><span></span></span></span></span></span><span class=mspace style=margin-right:0.16666666666666666em;></span><span class=mord><span class="mopen nulldelimiter"></span><span class=mfrac><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.32144em;><span style=top:-2.314em;><span class=pstrut style=height:3em;></span><span class=mord><span class="mord mathnormal" style=margin-right:0.03588em;>q</span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:0.13889em;>T</span><span class=mclose><span class=mclose>)</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:0.740108em;><span style=top:-2.9890000000000003em;margin-right:0.05em;><span class=pstrut style=height:2.7em;></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span><span style=top:-3.23em;><span class=pstrut style=height:3em;></span><span class=frac-line style=border-bottom-width:0.04em;></span></span><span style=top:-3.677em;><span class=pstrut style=height:3em;></span><span class=mord><span class=mord>1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:0.936em;><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>
</blockquote></div>

<h3 id=difference>What's the Difference?</h3>
<p>When the exponent <code>n</code> is an integer, Fortran <code>x**n</code> behaves
much differently than Python. In Fortran, optimized assembly is generated to
minimize the number of multiplications, whereas Python calls out to <code>pow()</code>
from <code>math.h</code> in C. Compare an explicit vs. implicit implementation in Python:</p>
<div class=highlight><pre><span></span><code><span class=k>def</span> <span class=nf>fourth_explicit</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
    <span class=n>squared</span> <span class=o>=</span> <span class=n>value</span> <span class=o>*</span> <span class=n>value</span>
    <span class=k>return</span> <span class=n>squared</span> <span class=o>*</span> <span class=n>squared</span>


<span class=k>def</span> <span class=nf>fourth_pow</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
    <span class=k>return</span> <span class=n>value</span> <span class=o>**</span> <span class=mi>4</span>
</code></pre></div>

<p>For well-behaved values, these two functions compute
<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi mathvariant=normal>/</mi><msup><mi>q</mi><mn>4</mn></msup></mrow><annotation encoding="application/x-tex">1 / q^4</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.064108em;vertical-align:-0.25em;></span><span class=mord>1/</span><span class=mord><span class="mord mathnormal" style=margin-right:0.03588em;>q</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:0.8141079999999999em;><span style=top:-3.063em;margin-right:0.05em;><span class=pstrut style=height:2.7em;></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span> without much difference</p>
<div class=highlight><pre><span></span><code><span class=o>&gt;&gt;&gt;</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>fourth_explicit</span><span class=p>(</span><span class=mf>0.25</span><span class=p>)</span>
<span class=mf>256.0</span>
<span class=o>&gt;&gt;&gt;</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>fourth_pow</span><span class=p>(</span><span class=mf>0.25</span><span class=p>)</span>
<span class=mf>256.0</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>quality</span> <span class=o>=</span> <span class=mf>0.2689565746627065</span>
<span class=o>&gt;&gt;&gt;</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>fourth_explicit</span><span class=p>(</span><span class=n>quality</span><span class=p>)</span>
<span class=mf>191.1046874202122</span>
<span class=o>&gt;&gt;&gt;</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>fourth_pow</span><span class=p>(</span><span class=n>quality</span><span class=p>)</span>
<span class=mf>191.10468742021223</span>
</code></pre></div>

<p>however when <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0.625em;vertical-align:-0.19444em;></span><span class="mord mathnormal" style=margin-right:0.03588em;>q</span></span></span></span> becomes small (the type of values we are
penalizing) the magnitude of <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi mathvariant=normal>/</mi><msup><mi>q</mi><mn>4</mn></msup></mrow><annotation encoding="application/x-tex">1 / q^4</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.064108em;vertical-align:-0.25em;></span><span class=mord>1/</span><span class=mord><span class="mord mathnormal" style=margin-right:0.03588em;>q</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:0.8141079999999999em;><span style=top:-3.063em;margin-right:0.05em;><span class=pstrut style=height:2.7em;></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span> means that small
relative differences are still large absolute differences in our objective
function:</p>
<div class=highlight><pre><span></span><code><span class=o>&gt;&gt;&gt;</span> <span class=n>quality</span> <span class=o>=</span> <span class=mf>2.3824755061912883e-06</span>
<span class=o>&gt;&gt;&gt;</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>fourth_explicit</span><span class=p>(</span><span class=n>quality</span><span class=p>)</span>
<span class=mf>3.103746353229757e+22</span>
<span class=o>&gt;&gt;&gt;</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>fourth_pow</span><span class=p>(</span><span class=n>quality</span><span class=p>)</span>
<span class=mf>3.103746353229758e+22</span>
<span class=o>&gt;&gt;&gt;</span>
<span class=o>&gt;&gt;&gt;</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>fourth_explicit</span><span class=p>(</span><span class=n>quality</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>fourth_pow</span><span class=p>(</span><span class=n>quality</span><span class=p>)</span>
<span class=o>-</span><span class=mf>8388608.0</span>
</code></pre></div>

<p>The difference is caused by the fact that <code>pow()</code> treats everything like a
floating point number and uses <code>exp()</code>, <code>log()</code> and multiplication via</p>
<div class=katex-elt><blockquote>
<span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display=block><semantics><mrow><msup><mi>x</mi><mi>y</mi></msup><mo>=</mo><msup><mi>e</mi><mrow><mi>y</mi><mi>log</mi><mo>⁡</mo><mo stretchy=false>(</mo><mi>x</mi><mo stretchy=false>)</mo></mrow></msup><mi mathvariant=normal>.</mi></mrow><annotation encoding="application/x-tex">x^y = e^{y \log(x)}.</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:0.714392em;vertical-align:0em;></span><span class=mord><span class="mord mathnormal">x</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:0.714392em;><span style=top:-3.1130000000000004em;margin-right:0.05em;><span class=pstrut style=height:2.7em;></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:0.03588em;>y</span></span></span></span></span></span></span></span><span class=mspace style=margin-right:0.2777777777777778em;></span><span class=mrel>=</span><span class=mspace style=margin-right:0.2777777777777778em;></span></span><span class=base><span class=strut style=height:0.938em;vertical-align:0em;></span><span class=mord><span class="mord mathnormal">e</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:0.938em;><span style=top:-3.113em;margin-right:0.05em;><span class=pstrut style=height:2.7em;></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:0.03588em;>y</span><span class="mspace mtight" style=margin-right:0.19516666666666668em;></span><span class="mop mtight"><span class=mtight>l</span><span class=mtight>o</span><span class=mtight style=margin-right:0.01389em;>g</span></span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class=mord>.</span></span></span></span></span>
</blockquote></div>

<h3 id=fortran-algorithm>Fortran's Nifty Algorithm</h3>
<p>Breaking down the <a href="https://godbolt.org/z/eq6MGh">assembly</a> for <code>b = a**4</code> in Fortran we see the repeated
squaring</p>
<div class=highlight><pre><span></span><code><span class=nl>pow4:</span>
  <span class=nf>movsd</span> <span class=no>xmm0</span><span class=p>,</span> <span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rdi</span><span class=p>]</span>
  <span class=nf>mulsd</span> <span class=no>xmm0</span><span class=p>,</span> <span class=no>xmm0</span>
  <span class=nf>mulsd</span> <span class=no>xmm0</span><span class=p>,</span> <span class=no>xmm0</span>
  <span class=nf>movsd</span> <span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsi</span><span class=p>],</span> <span class=no>xmm0</span>
  <span class=nf>ret</span>
</code></pre></div>

<p>as compared to a jump (<code>jmp</code>) instruction <a href="https://godbolt.org/z/b5nYed">in C</a></p>
<div class=highlight><pre><span></span><code><span class=nl>pow4:</span>
  <span class=nf>movsd</span> <span class=no>xmm1</span><span class=p>,</span> <span class=no>QWORD</span> <span class=no>PTR</span> <span class=no>.LC0</span><span class=p>[</span><span class=no>rip</span><span class=p>]</span>
  <span class=nf>jmp</span> <span class=no>pow</span>
<span class=nl>.LC0:</span>
  <span class=na>.long</span> <span class=mi>0</span>
  <span class=na>.long</span> <span class=mi>1074790400</span>
</code></pre></div>

<p>Similarly for <code>q**7</code> the assembly <a href="https://godbolt.org/z/f7EPWP">shows</a> only multiplications (vs. a <code>jmp</code>)</p>
<div class=highlight><pre><span></span><code><span class=nl>pow7:</span>
  <span class=nf>movsd</span> <span class=no>xmm0</span><span class=p>,</span> <span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rdi</span><span class=p>]</span>
  <span class=nf>movapd</span> <span class=no>xmm1</span><span class=p>,</span> <span class=no>xmm0</span>
  <span class=nf>mulsd</span> <span class=no>xmm1</span><span class=p>,</span> <span class=no>xmm0</span>
  <span class=nf>mulsd</span> <span class=no>xmm0</span><span class=p>,</span> <span class=no>xmm1</span>
  <span class=nf>mulsd</span> <span class=no>xmm1</span><span class=p>,</span> <span class=no>xmm1</span>
  <span class=nf>mulsd</span> <span class=no>xmm0</span><span class=p>,</span> <span class=no>xmm1</span>
  <span class=nf>movsd</span> <span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsi</span><span class=p>],</span> <span class=no>xmm0</span>
  <span class=nf>ret</span>
</code></pre></div>

<h3 id=assembly>I Don't Speak Assembly</h3>
<p>Like most professional software engineers (and science PhDs who write code) I
have no formal training, so reading assembly is something I've never done.
So I wrote a <a href="/code/describe_assembly.py">script</a> to generate a Fortran subroutine that computes
<code>b = a**n</code> for a fixed value of <code>n</code>, compiles the code to an object file
and then disassembles it. For example:</p>
<div class=highlight><pre><span></span><code>$ gfortran -c -O3 ./pow7.f90 -o ./pow7.o -J ./
$ objdump --disassemble ./pow7.o
</code></pre></div>

<p>However, these instructions are still hard to visualize so I parsed the
disassembled instructions from the object file and tracked all of the
active registers (<code>%xmm{N}</code>) as they were updated. In addition to the <code>xmm</code>
registers, the <code>%rsi</code> (source) and <code>%rdi</code> (destination) registers are used
for copying data <strong>from</strong> <code>a</code> and <strong>to</strong> <code>b</code> after the computation is done.</p>
<p>Being able to visualize this really helped! For <code>n = 4</code> we can see the
generated assembly is efficient enough that it only requires one register</p>
<div class=highlight><pre><span></span><code>$ python ./describe_assembly.py --exponent 4
+-------------------+
|     %xmm0[:64]    |
+-------------------+
|         a         | f2 0f 10 07     movsd   [(%rdi), %xmm0 ]
|       a * a       | f2 0f 59 c0     mulsd   [ %xmm0, %xmm0 ]
| (a * a) * (a * a) | f2 0f 59 c0     mulsd   [ %xmm0, %xmm0 ]
|         b         | f2 0f 11 06     movsd   [ %xmm0, (%rsi)]
+-------------------+
</code></pre></div>

<p>and <code>n = 7</code> can do all of its work in two registers</p>
<div class=highlight><pre><span></span><code>$ python ./describe_assembly.py --exponent 7
+-------------------------------------+-------------------+
|              %xmm0[:64]             |     %xmm1[:64]    |
+-------------------------------------+-------------------+
|                  a                  |                   | f2 0f 10 07     movsd   [(%rdi), %xmm0 ]
|                  a                  |         a         | 66 0f 28 c8     movapd  [ %xmm0, %xmm1 ]
|                  a                  |       a * a       | f2 0f 59 c8     mulsd   [ %xmm0, %xmm1 ]
|             (a * a) * a             |       a * a       | f2 0f 59 c1     mulsd   [ %xmm1, %xmm0 ]
|             (a * a) * a             | (a * a) * (a * a) | f2 0f 59 c9     mulsd   [ %xmm1, %xmm1 ]
| ((a * a) * (a * a)) * ((a * a) * a) | (a * a) * (a * a) | f2 0f 59 c1     mulsd   [ %xmm1, %xmm0 ]
|                  b                  |                   | f2 0f 11 06     movsd   [ %xmm0, (%rsi)]
+-------------------------------------+-------------------+
</code></pre></div>

<blockquote>
<p><strong>PS</strong>: It's worth noting here that black box analysis of the generated
assembly is not the only way to understand what <code>gfortran</code> will do. I
attempted to dive into the source for <code>gfortran</code> to understand exactly how
this is generated (in particular if it differs when the exponent <code>n</code> is not
known until runtime). However, I was not able to find any conclusive section
of code responsible and ran out of time digging.</p>
</blockquote><ol class=simple-footnotes><li id=sf-pow-confusion-1>The project unfortunately never led to
results that could be published. <a href=#sf-pow-confusion-1-back class=simple-footnote-back>↩</a></li><li id=sf-pow-confusion-2>I.e., values of type <code>double</code> in C <a href=#sf-pow-confusion-2-back class=simple-footnote-back>↩</a></li><li id=sf-pow-confusion-3>and related algorithms <a href=#sf-pow-confusion-3-back class=simple-footnote-back>↩</a></li><li id=sf-pow-confusion-4>It's worth noting that for our purposes a
<a href="https://en.wikipedia.org/wiki/Triangle_mesh">trianglular mesh</a> is just a collection of triangles that share edges, so if
one triangle changes, the neighboring triangles must as well. <a href=#sf-pow-confusion-4-back class=simple-footnote-back>↩</a></li></ol></div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">
        Danny Hermes (dhermes@bossylobster.com)
    </span>
  </span>
<time datetime="2020-11-25T00:00:00-08:00" pubdate>Nov 25, 2020</time>  <span class="categories">
    <a class="category" href="https://blog.bossylobster.com/tag/math.html">Math</a>,    <a class="category" href="https://blog.bossylobster.com/tag/programming.html">Programming</a>,    <a class="category" href="https://blog.bossylobster.com/tag/algorithms.html">Algorithms</a>  </span>
</p><div class="sharing">
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="https://blog.bossylobster.com/2020/11/pow-confusion.html" data-via="bossylobster" data-counturl="https://blog.bossylobster.com/2020/11/pow-confusion.html" >Tweet</a>
  <div class="g-plusone" data-size="medium"></div>
</div>    </footer>
  </article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
  </section>
</div>
<aside class="sidebar">
  <section class="sidebar-img">
    <img src="https://blog.bossylobster.com/images/bossy_lobster_350_alpha.png" alt="" width=""/>
    <img src="https://blog.bossylobster.com/images/dhermes_headshot.jpg" />
  </section>
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="https://blog.bossylobster.com/2022/08/tailscale-terraform-fargate.html">Managing Tailscale subnet routers with Terraform</a>
      </li>
      <li class="post">
          <a href="https://blog.bossylobster.com/2022/05/npm-mod.html">What npm Can Learn from Go</a>
      </li>
      <li class="post">
          <a href="https://blog.bossylobster.com/2022/04/emulate-rds-permissions.html">Emulating RDS Permissions with Terraform</a>
      </li>
      <li class="post">
          <a href="https://blog.bossylobster.com/2022/03/blend-epitaph.html">Epitaph: Blend</a>
      </li>
      <li class="post">
          <a href="https://blog.bossylobster.com/2022/02/how-to-write-github-actions-in-go.html">How to Write GitHub Actions in Go</a>
      </li>
    </ul>
  </section>




<section>
    <a href="http://twitter.com/bossylobster" class="twitter-follow-button" data-show-count="true">Follow @bossylobster</a>
</section>
<section>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive-blog-ad -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4173900012268590"
     data-ad-slot="9363500864"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

</section>
</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2011&ndash;2022  Danny Hermes &mdash;
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
  <script src="https://blog.bossylobster.com/theme/js/modernizr-2.0.js"></script>
  <script src="https://blog.bossylobster.com/theme/js/ender.js"></script>
  <script src="https://blog.bossylobster.com/theme/js/octopress.js" type="text/javascript"></script>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-56716324-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-56716324-1');
    ga('send', 'pageview');
</script>
  <script type="text/javascript">
    var disqus_shortname = 'bossylobster';
    var disqus_identifier = '/2020/11/pow-confusion.html';
    var disqus_url = 'https://blog.bossylobster.com/2020/11/pow-confusion.html';
    var disqus_title = "<p><code>pow</code> Confusion</p>";
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = "//" + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
  </script>
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>
</body>
</html>