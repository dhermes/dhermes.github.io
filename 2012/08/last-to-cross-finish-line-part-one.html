<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Last to Cross the Finish Line: Part One</title>
  <meta name="author" content="Danny Hermes">


    <style type="text/css">
  div.katex-elt {
    text-align: center;
  }
  div.katex-elt > blockquote {
    font-size: x-large;
    overflow-x: auto;
    overflow-y: hidden;
  }
</style>
<link href="/css/katex.min.css" rel="stylesheet" type="text/css"/>
<script src="/js/katex.min.js" type="text/javascript"></script>


  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="/favicon.png" rel="icon">
  <link href="/theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">
  <script src="/theme/js/modernizr-2.0.js"></script>
  <script src="/theme/js/ender.js"></script>
  <script src="/theme/js/octopress.js" type="text/javascript"></script>

  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="/">Bossylobster Blog</a></h1>
    <h2>Musings on humor/tech/mathematics/sports from the bossiest lobster</h2>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>


<form action="//google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>

<ul class="main-navigation">
    <li><a href="/archives.html">All Posts</a></li>
    <li><a href="http://github.com/dhermes/">GitHub Profile</a></li>
    <li><a href="http://math.berkeley.edu/~dhermes/">Berkeley Page</a></li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">Last to Cross the Finish Line: Part One</h1>
      <p class="meta"><time datetime="2012-08-27T00:00:00-07:00" pubdate>Aug 27, 2012</time></p>
</header>

  <div class="entry-content"><p>Recently, my colleague <a href="https://plus.google.com/115640166224745944209">+Fred
Sauer</a> and I gave a tech
talk called "Last Across the Finish Line: Asynchronous
<a href="https://developers.google.com/appengine/docs/python/taskqueue/overview">Tasks</a>
with <a href="https://appengine.google.com/">App Engine</a>". This is part one in a
three part series where I will share our
<a href="http://www.forbes.com/pictures/ekij45gdh/learnings/#gallerycontent">learnings</a>and
give some helpful references to the<a href="https://developers.google.com/appengine/docs/">App Engine
documentation</a>.</p>
<h2><span style="font-size: large;">Intro</span></h2>
<p>Before I dive in, a quick overview of our approach:</p>
<ul>
<li>"Fan out; Fan in" First spread tasks over independent workers; then
    gather the results back together</li>
<li>Use task queues to perform background work in parallel<ul>
<li>Tasks have built-in retries</li>
<li>Can respond quickly to the client, making UI more responsive</li>
</ul>
</li>
<li>Operate asynchronously when individual tasks can be executed
    independently, hence can be run concurrently<ul>
<li>If tasks are too work intensive to run synchronously, (attempt
    to) break work into small independent pieces</li>
</ul>
</li>
<li>Break work into smaller tasks, for example:<ul>
<li>rendering media (sounds, images, video)</li>
<li>retrieving and parsing data from an external service (Google
    Drive, Cloud Storage, GitHub, ...)</li>
</ul>
</li>
<li>Keep track of all workers; notify client when work is complete</li>
</ul>
<p>Before talking about the sample, let's check it out in action:</p>
<div style="text-align: center;">

</div>

<p>We are randomly generating a color in a worker and sending it back to
the client to fill in a square in the "quilt". (Thanks to <a href="https://plus.google.com/103073491679741548297">+Iein
Valdez</a> for this term.)
In this example, think of each square as a (most likely more complex)
compute task.</p>
<h2><span style="font-size: large;">Application Overview</span></h2>
<p>The
<a href="https://github.com/GoogleCloudPlatform/appengine-last-across-the-finish-line-python">application</a>has
a simple structure:</p>
<p>~~~~ {.prettyprint style="background-color: white;"}
gae-last-across-the-finish-line/|-- app.yaml|-- display.py|-- main.py|-- models.py+-- templates/       +-- main.html</p>
<div class="highlight"><pre><span class="nx">We</span><span class="s1">&#39;ll inspect each of the Python modules &lt;span</span>
<span class="s1">style=&quot;color: lime; font-family: Courier New, Courier, monospace;&quot;&gt;display.py&lt;/span&gt;,</span>
<span class="s1">&lt;span</span>
<span class="s1">style=&quot;color: lime; font-family: Courier New, Courier, monospace;&quot;&gt;main.py&lt;/span&gt;</span>
<span class="s1">and &lt;span</span>
<span class="s1">style=&quot;color: lime; font-family: Courier New, Courier, monospace;&quot;&gt;models.py&lt;/span&gt;individually</span>
<span class="s1">and explore how they interact with one another. In addition to this,</span>
<span class="s1">we&#39;</span><span class="nx">ll</span> <span class="nx">briefly</span> <span class="nx">inspect</span> <span class="nx">the</span> <span class="nx">HTML</span> <span class="ow">and</span> <span class="nb">Javascript</span> <span class="n">contained</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">template</span>
<span class="o">&lt;</span><span class="nx">span</span>
<span class="n">style</span><span class="o">=</span><span class="s2">&quot;color: lime; font-family: Courier New, Courier, monospace;&quot;</span><span class="o">&gt;</span><span class="nx">main.html</span><span class="o">&lt;/</span><span class="nx">span</span><span class="o">&gt;</span><span class="p">,</span>
<span class="k">to</span> <span class="nx">understand</span> <span class="nx">how</span> <span class="nx">the</span> <span class="nb">workers</span> <span class="nb">pass</span> <span class="nx">messages</span> <span class="nb">back</span> <span class="k">to</span> <span class="nx">the</span> <span class="n">client.</span>

<span class="k">In</span> <span class="nx">this</span> <span class="nx">post</span><span class="p">,</span> <span class="nx">I</span> <span class="nx">will</span> <span class="nx">explain</span> <span class="nx">the</span> <span class="nx">actual</span> <span class="nx">background</span> <span class="nx">work</span> <span class="nx">we</span> <span class="nx">did</span> <span class="ow">and</span>
<span class="nx">briefly</span> <span class="nb">touch</span> <span class="k">on</span> <span class="nx">the</span> <span class="nx">methods</span> <span class="nb">for</span> <span class="nx">communicating</span> <span class="k">with</span> <span class="nx">the</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">but</span>
<span class="nx">won</span><span class="s1">&#39;t get into client side code or the generic code for running the</span>
<span class="s1">workers and watching them all as they cross the finish line. In the</span>
<span class="s1">second post, we&#39;</span><span class="nx">ll</span> <span class="nx">examine</span> <span class="nx">the</span> <span class="nx">client</span> <span class="nx">side</span> <span class="nb">code</span> <span class="n">and</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">third</span><span class="p">,</span> <span class="nx">we</span><span class="s1">&#39;ll</span>
<span class="s1">discuss the models that orchestrate the work.</span>

<span class="s1">&lt;span style=&quot;font-size: large;&quot;&gt;Workers&lt;/span&gt;</span>
<span class="s1">----------------------------------------------</span>

<span class="s1">These worker methods are defined in[&lt;span</span>
<span class="s1">style=&quot;color: lime; font-family: Courier New, Courier, monospace;&quot;&gt;display.py&lt;/span&gt;](http://code.google.com/p/gae-last-across-the-finish-line/source/browse/display.py).</span>
<span class="s1">To generate the random colors, we simply choose a hexadecimal digit six</span>
<span class="s1">different times and throw a &lt;span</span>
<span class="s1">style=&quot;color: lime; font-family: Courier New, Courier, monospace;&quot;&gt;\#&lt;/span&gt;</span>
<span class="s1">on at the beginning:</span>

<span class="s1">~~~~ {.prettyprint style=&quot;background-color: white;&quot;}</span>
<span class="s1">import randomHEX_DIGITS = &#39;</span><span class="mi">0123456789</span><span class="nx">ABCDEF</span><span class="s1">&#39;def RandHexColor(length=6):  result = [random.choice(HEX_DIGITS) for _ in range(length)]  return &#39;</span><span class="err">#</span><span class="s1">&#39; + &#39;&#39;.join(result)</span>
</pre></div>


<p>With <span
style="color: lime; font-family: Courier New, Courier, monospace;">RandHexColor</span>
in hand, we define a worker that will take a row and column to be
colored and a session ID that will identify the client requesting the
work. This worker will generate a random color and then send it to the
specified client along with the row and column.To pass messages to the
client, we use the <a href="https://developers.google.com/appengine/docs/python/channel/">Channel
API</a>and
serialize our messages using the <a href="http://docs.python.org/library/json.html"><span
style="color: lime; font-family: Courier New, Courier, monospace;">json</span></a>
library in Python.</p>
<p>~~~~ {.prettyprint style="background-color: white;"}
import jsonfrom google.appengine.api import channeldef SendColor(row, column, session_id):  color = RandHexColor(length=6)  color_dict = {'row': row, 'column': column, 'color': color}  channel.send_message(session_id, json.dumps(color_dict))
~~~~</p>
<h2><span style="font-size: large;">Next...</span></h2>
<p>In the <a href="http://blog.bossylobster.com/2012/08/last-to-cross-finish-line-part-two.html">next
post</a>,
we'll explore the <a href="https://developers.google.com/appengine/docs/python/tools/webapp/running">WSGI
handlers</a>
that run the application and the client side code that handles the
messages from the workers.</p>
<p><a href="https://profiles.google.com/114760865724135687241" rel="author" style="display: none;">About Bossy Lobster</a></p></div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">Danny Hermes (dhermes@bossylobster.com)</span>
  </span>
<time datetime="2012-08-27T00:00:00-07:00" pubdate>Aug 27, 2012</time>  <span class="categories">
    <a class="category" href="/tag/appengine.html">AppEngine</a>
    <a class="category" href="/tag/deferred-library.html">Deferred Library</a>
    <a class="category" href="/tag/google-app-engine.html">Google App Engine</a>
    <a class="category" href="/tag/google-codesite.html">Google Codesite</a>
    <a class="category" href="/tag/javascript.html">Javascript</a>
    <a class="category" href="/tag/python.html">Python</a>
    <a class="category" href="/tag/task-queue-api.html">Task Queue API</a>
  </span>
</p><div class="sharing">
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="/2012/08/last-to-cross-finish-line-part-one.html" data-via="bossylobster" data-counturl="/2012/08/last-to-cross-finish-line-part-one.html" >Tweet</a>
  <div class="g-plusone" data-size="medium"></div>
</div>    </footer>
  </article>

</div>
<aside class="sidebar">
  <section>
    <img src="/images/bossy_lobster_200_alpha.png" alt="" width=""/>
  </section>
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="/2014/09/quantitative-interview-brain-teaser.html">Quantitative Interview Brain Teaser: Computer Assistance</a>
      </li>
      <li class="post">
          <a href="/2014/09/quantitative-brain-teaser-brain-only.html">Quantitative Brain Teaser: Brain Only</a>
      </li>
      <li class="post">
          <a href="/2014/08/math-for-humans-second-attempt.html">Math for Humans, A Second Attempt</a>
      </li>
      <li class="post">
          <a href="/2014/07/bayes-law-primer.html">Bayes' Law Primer</a>
      </li>
      <li class="post">
          <a href="/2014/07/conditional-probabilities-in-thinking.html">Conditional Probabilities in "Thinking Fast and Slow"</a>
      </li>
    </ul>
  </section>




<section>
    <a href="http://twitter.com/bossylobster" class="twitter-follow-button" data-show-count="true">Follow @bossylobster</a>
</section>
</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2011-2014  - Danny Hermes -
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>
</body>
</html>